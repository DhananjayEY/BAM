sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/type/String","sap/m/ColumnListItem","sap/m/Label","sap/m/SearchField","sap/m/Token","sap/m/MessageBox"],function(e,t,a,l,s,o,i,n,r){"use strict";var u;return{ValueHelp:function(t,a,n){a.InputId=t.getSource().getId();n.oColModel=new e(sap.ui.require.toUrl("com/ey/productattributes/model")+a.Columns);var r=new sap.ui.model.json.JSONModel;n.getView().setModel(r,"ValueHelpModel");var u=n.oColModel.getData().cols;n._oBasicSearchField=new i({showSearchButton:false,visible:false});n._oValueHelpDialog=sap.ui.xmlfragment("com.ey.productattributes.fragment."+a.Fragment,n);if(a.View==="Create"||a.View==="Edit"){n._oValueHelpDialog.setSupportMultiselect(false)}n._oValueHelpDialog.setRangeKeyFields([{label:a.label,key:a.key,type:"string",typeInstance:new l({},{maxLength:7})}]);n.getView().addDependent(n._oValueHelpDialog);n._oValueHelpDialog.getFilterBar().setBasicSearch(n._oBasicSearchField);n._oValueHelpDialog.getTableAsync().then(function(e){var t=n.getView().getModel("ValueHelpModel");t.setProperty(a.bindPath,"");e.setModel(t);e.setModel(n.oColModel,"columns");if(e.bindRows){e.bindAggregation("rows",a.bindPath)}if(e.bindItems){e.bindAggregation("items",a.bindPath,function(){return new s({cells:u.map(function(e){return new o({text:"{"+e.template+"}"})})})})}if(a.aList){e.getModel().setProperty(a.bindPath,a.aList)}n._oValueHelpDialog.update()}.bind(n));n._oValueHelpDialog.open();if(n.getView().byId(a.InputId).getMetadata()._sClassName!=="sap.m.Input"){n._oValueHelpDialog.setTokens(n.getView().byId(a.InputId).getTokens())}},OnConfirm:function(e,t){var a=e.getParameter("tokens"),l=t.params.InputId,s=t.getView().byId(l),o;o=t.params.Fragment==="ValueHelpDialogUser"?a[0].getText():a[0].getKey();if(!o){o=t.params.Fragment==="ValueHelpDialogUser"?a[1].getText():a[1].getKey()}if(t.params.View==="Create"||t.params.View==="Edit"){s.setValue(o)}else{s.setTokens(a)}t._oValueHelpDialog.close()},OnCancel:function(e){e._oValueHelpDialog.close()},AfterClose:function(e){e._oValueHelpDialog.destroy();e._oValueHelpDialog=undefined},OnSearch:function(e,l){var s=l._oBasicSearchField.getValue(),o=e.getParameter("selectionSet");var i=o.reduce(function(e,l){if(l.getName()==="Zagloctype"){if(l.getSelectedKey()){e.push(new t({path:l.getName(),operator:a.EQ,value1:l.getSelectedKey()}))}}else{if(l.getValue()){e.push(new t({path:l.getName(),operator:a.EQ,value1:l.getValue().trim()}))}else if(l.getTokens().length){$.each(l.getTokens(),function(t,a){e.push(new sap.ui.model.Filter({path:l.getName(),operator:sap.ui.model.FilterOperator.EQ,value1:a.getProperty("key").trim()}))})}}return e},[]);if(l.params.additionFilter!==undefined){i.push(new sap.ui.model.Filter({path:l.params.additionFilter.split("/")[0],operator:sap.ui.model.FilterOperator.EQ,value1:l.params.additionFilter.split("/")[1]}))}this._FilterTable(i,l)},_FilterTable:function(e,t){t._oValueHelpDialog.getTable().setBusyIndicatorDelay(0);t._oValueHelpDialog.getTable().setBusy(true);var a=t.params,l="/sap/opu/odata/sap/ZBAM_SUPPLY_PRODUCT_SRV/",s=new sap.ui.model.json.JSONModel,o=t._oValueHelpDialog,i=this;s=new sap.ui.model.odata.ODataModel(l,false);sap.ui.getCore().setModel(s);s.read(a.SearchSet,{filters:e,success:function(e,l){i.HandleResponse(l,a);i.SetList(l,a,o,t);o.getTable().setBusy(false)},error:function e(l){i.ResetList(a,o,t);o.getTable().setBusy(false);r.warning(i.handlErrorResponse(l))},async:true})},ResetList:function(e,t,a){a.List="";if(a._oValueHelpDialog===undefined){a._oValueHelpDialog=t}a._oValueHelpDialog.getTableAsync().then(function(t){t.getModel().setProperty(e.bindPath,a.List)}.bind(a))},SetList:function(e,t,a,l){l.List=e.data.results;l.params.aList=e.data.results;a.getTableAsync().then(function(e){e.getModel().setProperty(t.bindPath,l.List);a.update()}.bind(l))},HandleResponse:function(e,t){if(t.Fragment==="Product"){e.data.results.map(e=>{if(!e.Matnr.match(/[A-za-z]\w/)&&e.Matnr.match(/\w/)!==null){e.Matnr=e.Matnr.match(/[1-9]\d*/g)[0]}if(!e.Bismt.match(/[A-za-z]\w/)&&e.Bismt.match(/\w/)!==null&&e.Bismt.match(/[1-9]\d*/)!==null){e.Bismt=e.Bismt.match(/[1-9]\d*/g)[0]}},this);return}else{return}},handlErrorResponse:function(e){var t=new DOMParser,a=t.parseFromString(e.response.body,"text/xml"),l;if(e.response.body.startsWith("<?xml")){if(a.querySelector("message")!==undefined||a.querySelector("message")!==null){l=a.querySelector("message").firstChild.nodeValue}else{l=a.querySelector("h1").firstChild.nodeValue}}else{l=e.response.body!==""?e.response.body:e.message}return l}}});